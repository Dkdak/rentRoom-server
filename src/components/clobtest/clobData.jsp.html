<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Table Example</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .bold-header {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        #clob2Content {
            margin-top: 20px;
            border: 1px solid #000;
            padding: 10px;
        }
    </style>
</head>
<body>

<h2>Dynamic Table with Data from JSON</h2>
<table id="dataTable">
    <thead>
    <tr id="columnIdHeader"></tr>
    <tr id="columnNameHeader"></tr>
    </thead>
    <tbody>
    </tbody>
</table>
<button id="addRowBtn">Add Row</button>
<button id="saveBtn">Save Changes</button>

<div id="clob2Content">
    <h2>HTML from CLOB2</h2>
    <div id="clob2Html"></div>
</div>

<script>
    $(document).ready(function () {
        const id = 1; // 데이터 조회할 ID

        // CLOB1에서 JSON 데이터를 불러옴
        $.getJSON(`/api/clob1/${id}`, function (response) {
            const headers = response.headers;
            const data = response.data;

            // 헤더 동적 생성
            let columnIdHtml = '';
            headers.forEach(header => {
                columnIdHtml += `<th>${header.id}</th>`;
            });
            $('#columnIdHeader').html(columnIdHtml);

            let columnNameHtml = '';
            headers.forEach(header => {
                if (header.id.startsWith("resultFace")) {
                    columnNameHtml += `<th class="bold-header">${header.name}</th>`;
                } else {
                    columnNameHtml += `<th>${header.name}</th>`;
                }
            });
            $('#columnNameHeader').html(columnNameHtml);

            // 데이터 행 동적 생성
            let rowsHtml = '';
            data.forEach((row, rowIndex) => {
                rowsHtml += '<tr>';
                headers.forEach(header => {
                    rowsHtml += `<td><input type="text" value="${row[header.id]}" id="${header.id}_${rowIndex}"></td>`;
                });
                rowsHtml += '</tr>';
            });
            $('#dataTable tbody').html(rowsHtml);
        });

        // 새 행 추가
        $('#addRowBtn').click(function () {
            const headers = $('#columnIdHeader th');
            let newRowHtml = '<tr>';
            headers.each(function () {
                const headerId = $(this).text();
                newRowHtml += `<td><input type="text" value="" id="${headerId}_new"></td>`;
            });
            newRowHtml += '</tr>';
            $('#dataTable tbody').append(newRowHtml);
        });

        // 수정된 데이터를 CLOB1과 CLOB2에 저장
        $('#saveBtn').click(function () {
            let updatedData = [];
            $('#dataTable tbody tr').each(function (rowIndex) {
                let rowData = {};
                $(this).find('td input').each(function () {
                    const columnId = this.id.split('_')[0];
                    rowData[columnId] = $(this).val();
                });
                updatedData.push(rowData);
            });

            const htmlContent = `<html><head><title>Saved Table</title></head><body>${$('#dataTable').prop('outerHTML')}</body></html>`;

            $.ajax({
                url: `/api/save/${id}`,
                type: 'POST',
                data: JSON.stringify({ dataJson: JSON.stringify(updatedData), html: htmlContent }),
                contentType: 'application/json',
                success: function () {
                    alert('Data and HTML saved successfully');
                    $.get(`/api/clob2/${id}`, function (clob2Html) {
                        $('#clob2Html').html(clob2Html);
                    });
                },
                error: function () {
                    alert('Error saving data and HTML');
                }
            });
        });
    });
</script>

</body>
</html>
